{% extends "base.html" %}

{% block title %}高度な検索 - Gap Movies{% endblock %}

{% block content %}
<style>
.search-header {
    background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
    color: white;
    padding: 60px 0;
    text-align: center;
    margin-bottom: 40px;
}

.search-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 10px;
}

.search-container {
    background: white;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 40px;
}

.search-section {
    margin-bottom: 30px;
}

.section-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e2e8f0;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    color: #4a5568;
}

.form-input,
.form-select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s;
}

.form-input:focus,
.form-select:focus {
    outline: none;
    border-color: #4a5568;
}

.genre-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.genre-tag {
    padding: 8px 16px;
    background: #f7fafc;
    border: 2px solid #e2e8f0;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
}

.genre-tag:hover {
    border-color: #4a5568;
}

.genre-tag.active {
    background: #4a5568;
    color: white;
    border-color: #4a5568;
}

.btn-search {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-search:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 85, 104, 0.4);
}

.btn-reset {
    width: 100%;
    padding: 12px;
    background: white;
    color: #4a5568;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 10px;
}

.btn-reset:hover {
    border-color: #4a5568;
}

.results-section {
    margin-top: 40px;
}

.movie-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 25px;
}

.movie-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s;
    cursor: pointer;
}

.movie-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.movie-poster {
    width: 100%;
    height: 300px;
    object-fit: cover;
}

.movie-info {
    padding: 15px;
}

.movie-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 8px;
}

.movie-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
}

.movie-year {
    color: #718096;
    font-size: 0.9rem;
}

.movie-score {
    background: #4a5568;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}
</style>

<div class="search-header">
    <div class="container">
        <h1 class="search-title">高度な検索</h1>
        <p>詳細な条件で映画を検索できます</p>
    </div>
</div>

<div class="container">
    <div class="search-container">
        <form method="get" id="advancedSearchForm">
            <!-- キーワード検索 -->
            <div class="search-section">
                <h3 class="section-title">キーワード</h3>
                <div class="form-group">
                    <input type="text" name="q" class="form-input" placeholder="映画タイトル、監督名、キャストで検索" value="{{ query }}">
                </div>
            </div>

            <!-- ジャンル -->
            <div class="search-section">
                <h3 class="section-title">ジャンル</h3>
                <div class="genre-tags">
                    <div class="genre-tag" data-genre="アクション">アクション</div>
                    <div class="genre-tag" data-genre="コメディ">コメディ</div>
                    <div class="genre-tag" data-genre="ドラマ">ドラマ</div>
                    <div class="genre-tag" data-genre="ホラー">ホラー</div>
                    <div class="genre-tag" data-genre="SF">SF</div>
                    <div class="genre-tag" data-genre="ミステリー">ミステリー</div>
                    <div class="genre-tag" data-genre="ロマンス">ロマンス</div>
                    <div class="genre-tag" data-genre="スリラー">スリラー</div>
                    <div class="genre-tag" data-genre="アニメーション">アニメーション</div>
                    <div class="genre-tag" data-genre="ドキュメンタリー">ドキュメンタリー</div>
                </div>
                <input type="hidden" name="genre" id="genreInput" value="">
            </div>

            <!-- 公開年 -->
            <div class="search-section">
                <h3 class="section-title">公開年</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">開始年</label>
                        <input type="number" name="year_from" class="form-input" placeholder="1900" value="{{ year_from }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">終了年</label>
                        <input type="number" name="year_to" class="form-input" placeholder="2025" value="{{ year_to }}">
                    </div>
                </div>
            </div>

            <!-- ギャップスコア -->
            <div class="search-section">
                <h3 class="section-title">ギャップスコア</h3>
                <div class="form-group">
                    <select name="score" class="form-select">
                        <option value="">すべて</option>
                        <option value="high" {% if score_filter == 'high' %}selected{% endif %}>高評価（70点以上）</option>
                        <option value="medium" {% if score_filter == 'medium' %}selected{% endif %}>中評価（40-69点）</option>
                        <option value="low" {% if score_filter == 'low' %}selected{% endif %}>低評価（39点以下）</option>
                    </select>
                </div>
            </div>

            <!-- ソート -->
            <div class="search-section">
                <h3 class="section-title">並び順</h3>
                <div class="form-group">
                    <select name="sort" class="form-select">
                        <option value="title" {% if sort_by == 'title' %}selected{% endif %}>タイトル順</option>
                        <option value="gap_score" {% if sort_by == 'gap_score' %}selected{% endif %}>ギャップスコア順</option>
                        <option value="year_desc" {% if sort_by == 'year_desc' %}selected{% endif %}>公開年（新しい順）</option>
                        <option value="year_asc" {% if sort_by == 'year_asc' %}selected{% endif %}>公開年（古い順）</option>
                        <option value="review_count" {% if sort_by == 'review_count' %}selected{% endif %}>レビュー数順</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn-search">検索する</button>
            <button type="button" class="btn-reset" onclick="resetForm()">リセット</button>
        </form>
    </div>

    <!-- 検索結果 -->
    {% if results %}
    <div class="results-section">
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 20px;">
            検索結果: {{ result_count }}件
        </h2>
        <div class="movie-grid">
            {% for movie in results %}
            <a href="{% url 'movie_detail' movie.pk %}" style="text-decoration: none;">
                <div class="movie-card">
                    {% if movie.poster_url %}
                    <img src="{{ movie.poster_url }}" alt="{{ movie.title }}" class="movie-poster">
                    {% else %}
                    <div class="movie-poster" style="background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #718096;">
                        画像なし
                    </div>
                    {% endif %}
                    
                    <div class="movie-info">
                        <h3 class="movie-title">{{ movie.title }}</h3>
                        <div class="movie-meta">
                            <span class="movie-year">{{ movie.release_year }}</span>
                            <span class="movie-score">{{ movie.get_overall_gap_score }}</span>
                        </div>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
// ジャンルタグの選択
const genreTags = document.querySelectorAll('.genre-tag');
const genreInput = document.getElementById('genreInput');
let selectedGenres = [];

genreTags.forEach(tag => {
    tag.addEventListener('click', function() {
        const genre = this.dataset.genre;
        
        if (this.classList.contains('active')) {
            this.classList.remove('active');
            selectedGenres = selectedGenres.filter(g => g !== genre);
        } else {
            this.classList.add('active');
            selectedGenres.push(genre);
        }
        
        genreInput.value = selectedGenres.join(',');
    });
});

// リセット
function resetForm() {
    document.getElementById('advancedSearchForm').reset();
    genreTags.forEach(tag => tag.classList.remove('active'));
    selectedGenres = [];
    genreInput.value = '';
}
</script>

{% endblock %}